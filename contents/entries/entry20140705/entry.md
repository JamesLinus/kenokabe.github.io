#### KenOKABE tech blog
####[←ブログコンテンツ](http://kenokabe.github.io/contents/entries/entry0/entry.html)

#MacHackシリーズ
#### [生産性が飛躍的に向上するかもしれないMacキーマップ問題のイライラ解消ハック](http://qiita.com/kenokabe/items/59487f5dfbf14878a8ec)
　

#生産性が飛躍的に向上するかもしれないMacキーマップ問題のイライラ解消ハック



さて今回は、私が数年に渡り、MacBookPro,MacBookAirと何台も乗り換えるギーク生活で生き延びる過程で身につけた、生産性が飛躍的に向上するかもしれないMacキーマップ問題のイライラ解消ハックを共有したいと思います。

特に日本語入力についてはギークのみならず一般のMacユーザにとって必須の日常的ルーチンワークなのですが、巷ではあまり提供されていない情報で、ボトムラインとして私がMac入門者のときに大いに困った問題なので、きっと役立つと思います。

以下が我々Macユーザが直面し、多くの場合おざなりにされ未解決のまま放置されがちな、Macキーマップ問題です。

####日本語キーボード問題
####CapsLock問題　Commandキー問題
####日本語入力問題
####Google日本語IMEショートカットキー問題
####クロスプラットフォーム　Controlキー問題
####解決するアプリケーション２つ


キーボードとは我々がマウス、タッチパッドと共にPCと向き合う上で常に触れているインターフェイスであり、操作する手は脳と直結しており、やりたい操作⇒そのままPCに反映、という直感的なコンピューティングを実践するにはおざなりにできない要素です。

キーマップはそれぞれの好みもあるし設定もややこしいので「まあいいや、そのうち、、、」と放置していると、ずっとイライラすることになるので、解消することで、より直感的操作が可能になり、生産性も飛躍的に向上するかもしれません。

##日本語キーボード問題

日本語文化圏で生活する我々日本人特有の問題。
これは、今回のテーマであるMacキーマップ特有ではなくWindowsPCでもなんでも共通、プラットフォーム共通の問題です。

他の言語圏のキーボードについては詳しく知りませんが、日本語を操る日本人向け、日本国内向けのキーボードは世界的なデファクトスタンダードである英語キーボードとはかなり異なった様相をみせています。

Macの日本語・英語キーボードについてももちろんそうです。

![](http://kenokabe.github.io/contents/entries/entry20140705/img/mac-key-jp-en.png)

このように比較してみると、日本語キーボードのほうがゴチャゴチャしています。

理由は、
日本語（ひらがな）プリントが印字してある
日本語入力のための追加のキーがある
からです。

同一スペースに増量したキーを詰め込んでいるので、いろいろよくわからないことになっています。

まああまりこの辺を詰めて議論していくと、好みの問題、選択の問題でもあり、宗教論争になりかねないので語弊もあるでしょうが、個人的にはやはり日本語キーボードはごちゃごちゃしており、Macの持ち味でもあるシンプルな美しさが損なわれていると思います。

あと、日本語のひらがな、っていうのは美しい造形であり外国人からも結構評判がよい文字なのですが、自分の限られた知見では、多くの人はひらがなタイプでなくローマ字タイプするでしょうから、ひらがなタイプを得意とする一部の人以外は不要な表示である、ということになります。

さらに、Macでデフォルトで搭載されているコトエリ、JustSystemsのATOK、Google日本語IMEでは、日本語入力のために用意された余剰のキーは不要です。なくても困りません。

つまり、日本語（ひらがな）プリントにしても、キーにしても不要なわけで、そもそも世界的デファクトである英語キーボードを日本語キーボードにスイッチする合理的な理由は、広く使われるローマ字入力を選択した時点で完全に消滅している、ということになります。

使わないのにずっと手元にある、目の前にある、というのは結構気になるわけで、海外でPCを使うと日本語ガラパゴスを痛感しながら不自由感も味わうということになります。

そして実はUNIXの世界でも日本語キーボードには結構な弊害があり、ギークとしては非常によろしくありません。

たとえば　`＠`（アットマーク）です。
＠は元々、ユーザ名とドメイン名を区切るマークで、UNIXリモートホストにSSHでリモートログインするときに使用されたり、インターネットの世界ではメールアドレスに同じ文脈で使われるので超有名になりました。

英語キーボードでは`SHIFT+2`として、結構わかりやすい場所＋SHIFTなのですが、日本語キーボードではなんか右方向の中段のわかりやすい場所にあります。

たとえば ` と　~　です。英語キーボードでは左上のかなりわかりやすい、ブラインドタッチにしても間違いにくい（目立つ）押しやすい場所にあります。
今この記事はマークダウンで書いていますが、

`ある用語`みたいにボックスで囲む表示にするには　`　 で囲みます。

UNIXのホームディレクトリへのショートカットは　~ であり、ターミナルで頻繁に使います。

それが日本語キーボードでは＠同様にわかりやすい場所に埋没してしまっている。

`"` と  `'`

シングルとダブルのクォーテーションは、英語キーボードでは、`Return`キーのすぐとなりで、SHIFTなしがシングル、ありがダブル、と直感的ですが、日本語ではSHIFT＋`2`と`7`と離れており、かなりの確率でタイプミスをする。これは`node.js`や`Javascirpt`でコーディングするとかなりつらい状況です。

クォーテーションのすぐとなりは、英語キーボードでは、`;`と`:`でこれも同様にSHIFTありなしで、非常にわかりやすく、まずタイプミスをすることはありません。日本語キーボードでは別々のキー＋SHIFTで、自分はどちらがどうなのかブラインドタッチできた試しがありません。

さらに厄介なのが、[] {} 「」　です。
今自分がタイプしているのは、英語キーボードなので、これが左、右と何のリズムよく直感的に安々と連打できますが、日本語キーボードでは、左右でなくずれた上下なんですね。これは辛いし、おまけに『』が別のキーとして割り当てられていたりします。「」の変換し直しで表現できるものに、別のキーが割り当てられている。

あと日本語キーボードでは`＋`と`ー`が離れた位置にあったり、いろいろと不合理だなーと感じざるを得ない独特のレイアウトになっており、英語キーボードでは逆に考えぬかれた合理的配置になっていると痛感せざるを得ません。

英語キーボードで日本語キーボードのように「圧縮されていない」スペースキーがあると開放感さえ感じます。

Mac日本語キーボードではマシですが、別のメーカの日本語キーボードでは`半角/全角`キーが英語キーボードの　` と　~　にあたる左上の特等席に位置しており、頭痛すら覚えかねません。

ギークとしてコーディングする上で、以上のような日本語キーボードのレイアウトはかなり辛いものであります。これは合理性の問題であり、「慣れ」の問題ではないレベルで、英語キーボードでは作業が楽になります。

そういうことでこの記事はで英語キーボードを前提に書いていきます。ご了承下さい。

英語キーボードの評判を聞きつけ、自分も次のMacはスタイリッシュな英語キーボードにシてみようと思う！であるとか、英語キーボードに変えたもののいまいち使い勝手が悪い！と感じる英語キーボード入門者の方々にも役だつと思います。

##CapsLock問題　Commandキー問題

Mac、PC、英語・日本語キーボードにかかわらず、`CapsLock`キーはもっともやっかいな存在です。こう断言しても差し支えないでしょう。

やっかいな理由その１として、CapsLockとは、そのLockという名称の通り、状態（大文字/小文字モード）をもつ数少ない例外的なキーだからです。

ノートでないフルのキーボードではその他にNumbersLockというのがありますが、ノートでは唯一状態をもつ例外的なキーです。

これを不用意に押してしまい状態を変化させることで、自分が小文字でパスワード入力しているつもりが、大文字で入力しておりまた打ち直すはめになった、っていうのはすべての人が経験する頭の痛い問題でしょう。

そしてさらにやっかいなことに、このキーの有用性（メリット）は、そのようなデメリットに比べはるかに小さい、というのは、そんなLockしてまで大文字を連打することなど滅多にない、Windowsプロダクトキー入力のときしか「ああCapsLockがあれば便利だったのにな！」と憧れる機会がないというリターン/リスクレイシオ悪すぎ、コスパ悪すぎ、もっと言えば百害あって一利無しに限りなく近い無用なキーであると言えるでしょう。

斯くの如く無用なキーにも関わらず、英語キーボードではかなりいい位置に、左サイドのShiftキーの次の面積でCapsLockは大きく陣取っています。

日本語キーボードにおいては、この点「いくらなんでもあんまりだ」という日本語キー配列開発グループの発案なのでしょうが、この場所にはかわりにコントロールキーが陣取っており、左下のCapsLockは隅に追いやられてしまっています。

左下の隅に追いやられた、といっても、ここはここで結構な特等席であり、それでもやはり無用なキーの分際で「分不相応」に感じます。

##日本語入力問題

コトエリでは、Command+Spaceで英語・日本語を切り替えるみたいです。

デフォルトのコトエリ（ことえり）の変換はあんまり使えません。議論の余地はあまりないでしょう。

ATOKは有償で、再インストールの時にも使いまわすのが面倒で、ほとんどの人は無償のGoogle日本語IMEをインストールして使っていると思います。

##Google日本語IMEショートカットキー問題

GoogleIMEを使い始めて、まず頭が痛いのは、コトエリではそれなりにわかりやすかったモード切り替えのショートカットが、Jがどうだとかわかりにくいキーバインドになっていることです。

ほとんどの人はおおいに戸惑うでしょうし、使い続けても快適に慣れるとはとても思えないキーバインドです。
　

##クロスプラットフォーム　Controlキー問題

最後にプラットフォーム、OS環境の問題があります。

Macユーザはご存知のように、Commandキーなる他のOSやハードウェアにはない特殊な主要キーがあります。

Linuxには相当するものは存在せず、Windowsのハード・OSで言えば、Windowsキーに相当するかもしれませんが、実際あまり相当しているわけでもなく、WindowsではMacのCommandキーが担当する機能をほとんどControlキーが担います。この辺はWindowsとLinuxではControlキーの使い勝手がほぼ同じで、プラットフォーム差異にはあまり悩まされることがない、ということになります。

つまり、MacのCommandキーの存在はLinux,Windowsに比較して特殊で、相当するものがありません。

WindowsのリモートホストにRemoteDesktop（RDC）で接続して、Commandキーを押すと、Windowsでは、Windowsキーを押したのと同じになるので、スタートメニューが開き、Windows8ではあのややこしいメトロ画面になります。

当然、Macでお馴染みのCommand＋ c,x,v,a とコピー、カット、ペースト、全選択の操作を無意識にすると、メトロ画面が開いて「ああしまった、WindowsではCommandじゃなくContorolキーだったな・・・」と頭が痛くなります。

Mac環境の中でも、ターミナルは基本すべてUNIX文化圏です。
多くのターミナルアプリケーションは、MacのCommandキーバインドを受け付けず、Controlキーバインドで各種操作のショートカットキーが構成されています。
多くのUNIXとソースを共有するターミナルのコマンドアプリ環境下では、MacのCommandキーは無用の長物で、普段のMacの習慣でControlキーと間違って無意識に押し続けるやっかいな存在に成り果ててしまいます。頭が痛いですね。

##解決するアプリケーション２つ

以上の頭の痛い問題を一挙に解決して、イライラ解消、生産性が飛躍的に向上するかもしれない、すばらしいMacアプリがあります。

####[KeyRemap4MacBook](https://pqrs.org/macosx/keyremap4macbook/index.html.ja)
と
####[Seil (旧 PCKeyboardHack)](https://pqrs.org/macosx/keyremap4macbook/seil.html.ja)

です。

幸いなことに、秀逸なことに、両方とも同じ作者（日本人）によるアプリです。

キーマップのツール・アプリなのに、同じ作者が異なる2つのアプリをリリースしているのは理由があります。

[KeyRemap4MacBook](https://pqrs.org/macosx/keyremap4macbook/index.html.ja)は、Macのキーマップの上層レイヤーを設定し、かなり細かい設定が可能です。

一方、

[Seil (旧 PCKeyboardHack)](https://pqrs.org/macosx/keyremap4macbook/seil.html.ja)
は、Macのキーマップの下層レイヤーを設定し、直接的なOSレベルの設定が可能です。

だから、両者、微妙にクロスオーバーする領域があり、同時にどちらか一方でしか設定しえない領域もあります。

設定順序としては、もちろん、下層⇒上層であり、


1.先に、[Seil (旧 PCKeyboardHack)](https://pqrs.org/macosx/keyremap4macbook/seil.html.ja)でOSレベルで設定してから、

2.次に、[KeyRemap4MacBook](https://pqrs.org/macosx/keyremap4macbook/index.html.ja)で細かい設定で仕上げます。



###Macのキーマップの基礎知識とアプリを使ったハック

以下、すべてのキーリマップ設定を反映させるためにOSの再起動、再ログインは不要です。

####1. MacOSの設定
MacOSには、最初からOSに実装されているキーマップ設定があります。

「システム環境設定」アプリ
「キーボード」パネルの「キーボード」タブを開く。
　右下にある「修飾キー」ボタンを押す。

以下の画像は、私のOSが英語モードになっているので適当に読み替えてください。

![](http://kenokabe.github.io/contents/entries/entry20140705/img/SystemPreferences-Keyboard-ModifierKeys.png)

何もアプリを適用しないでも、この設定で厄介なCapsLockキーを別のキーに割り当てたり無効にしたりいろいろできます。

このOSレベルの設定をより範囲拡張したのが、今回紹介したアプリのひとつである、
[Seil (旧 PCKeyboardHack)](https://pqrs.org/macosx/keyremap4macbook/seil.html.ja)になります。

つまり、この画面のOSレベルのキーマップ設定とSeilアプリの設定は同レベルの設定をするので競合します。

たとえば、現在身分不相応に一等地を陣取っている`CapsLock`をMacでは操作で重要な役割を担う`Command`に席替えしてもらうためには、この上記画像のようにすれば、厄介な`CapsLock`は消滅し、そのキーを押すと代わりに`Command`を押したことになります。

そのまま元からあった`Command`キーを据え置くことにすれば、`Command`キーは2つある、ということになりますが、私の場合同じ機能を持つキーが2箇所に存在するのは、限られたキーボード資源の無駄遣いで、慣れるのに混乱を招くと考えるので、この画像のように、Commandには`No Action`を割り当てて、空席にしています。

もちろん、空席になった旧`Command`の位置には、後で、Seilを使って別の重要なキーを割り当てて有効活用するのです。
システム・キー・修飾設定とSeilは競合するので、あとで詳細に設定したい部分はすべて`NoAction`にしておきます。

もちろん、この上記設定もすべてSeilのほうでやることが可能で、もうこの画面であらかじめ全部のキーを`NoAction`に揃えておき、Seilで一貫して設定していったほうがわかりやすいかもしれません。

####2. Seilの設定

Seilでの設定はこんな感じです。
![](http://kenokabe.github.io/contents/entries/entry20140705/img/Seil.png)

Seilの設定は単純で、あるハードウェアキーを別のハードウェアキーに１：１でリマップする、それだけです。

上半分に設定UIがあり、下半分にキーマップのアスキーコードがリファレンスとしてあり活用できます。

ちょうど、`CapsLock`がありますが、すでにMacOSのほうで`Commmand`に席替えしてしまったので、このままチェックもいれません。入れてCommand以外の別のキーコードにしてしまうと競合します。
MacOSのほうで、`NoAction`にしている場合は、ここで`Left Command`のキーコードである`55`にすると、同様に`CapsLock`⇒`Left Command`になります。

次に、今現在は空席となっている`Left Command`に、`F18`キーをリマップします。キーコードは画像のように`79`になっています。

同時に、`Right Command`に`F19`キーをリマップします。キーコードは`80`です。

ここで、`F18`と`F19`という通常キーボード上にもない絶対に使わないキーをそれぞれ、左右のCommandキーにリマップしたのは、後のKeyRemap4MacBookでの上層での設定を見越したもので、完全に他のキーとの競合を避けながら、修飾（Modifier）キーからファンクションキーのような通常キーにOSレベルで挿げ替えるためです。

これで、無用な機能の`CapsLock`キーの特等席は、頻繁に使用する`Command`キーの機能のために割り当てられ、左右の`Command`キーの場所は、`F18`と`F19`という別の重要な機能のために席が予約されました。

####3. KeyRemap4MacBookの設定

#####席を予約した別の重要な機能とは、もちろんGoogle日本語IMEの英語・日本語モード切り替え機能のことです。

Google日本語IMEのデフォルトのキーバインドでは、

英語入力   `Control + Shift + ;`
日本語入力 `Control + shift + j`

ということで、格闘ゲームの特殊コマンドの様相を呈しており、かなり辛いですね。慣れるとは思えません・・・

そこで、KeyRemap4MacBookの出番です。

こういう複雑なキーコンビネーションを束ねて、たった一つのハードウェアキー（OSレベル、Seilですでにリマップ済みのキー）にマップすることができるのが、KeyRemap4MacBookの機能です。

KeyRemap4MacBookでは、かなり細かく柔軟な設定が可能です。Seilではハードウェアキー１：１のリマップで設定も至極単純で終ったのですが、ここでは結構複雑になります。

![](http://kenokabe.github.io/contents/entries/entry20140705/img/KeyRemap4MacBook.png)

多くの場合、この`ChangeKey`タブで設定できますが、GoogleIMEのような複雑なキーコンビネーションのマップはここではできません。

`private.xml`という設定ファイルで細かく定義してやる必要があります。

`Misc&Uninstll`という右端のマイナーな位置にあるタブを開き、
![](http://kenokabe.github.io/contents/entries/entry20140705/img/private-xml.png)
Custom Settingの`Open private.xml`を押します。

すると、`priate.xml`があるディレクトリがFinderなりで開くはずです。

ファイルを編集するために、`priate.xml`を適当なエディタで開きます。(こういうちょっとした操作のためにCotEditorがオススメ)

以下が、
- ハードウェアキーである`F18`(旧`Left Command`)にGoogleIMEの英語モードのキーコンビネーションを割り当てる
- ハードウェアキーである`F19`(旧`Right Command`)にGoogleIMEの日本語モードのキーコンビネーションを割り当てる
コードです。

#####private.xml
```
<?xml version="1.0" ?>
<root>
  <item>
    <name>custom</name>
    <identifier>custom</identifier>

    <autogen>
      --KeyToKey-- KeyCode::F18, KeyCode::SEMICOLON, ModifierFlag::SHIFT_L | ModifierFlag::CONTROL_L
    </autogen>

    <autogen>
      --KeyToKey-- KeyCode::F19, KeyCode::J, ModifierFlag::SHIFT_L | ModifierFlag::CONTROL_L
    </autogen>

  </item>
</root>

```

以上をコピペして、ファイルを保存します。

もう一度、最初のタブ`Change Key`に戻り、右上の`ReloadXML`を押し`private.xml`ファイルをアプリに読み込みます。

コードの中で、適当に`custom`と名前づけしたので、タブペーン上に`custom`が追加されているはずです。忘れずにチェックを入れて有効化します。

![](http://kenokabe.github.io/contents/entries/entry20140705/img/KeyRemap4MacBook.png)


これで、Google日本語入力で、

英語モードにする　　←　左Commandキー
日本語モードにする　←　右Commandキー

という設定になりました。なっているはずです。

何かがおかしい？と感じれば、
KeyRemap4MacBookのメニューバー上のアイコンを右クリックして出てくる
`Launch EvetViewer`　でキーのイベントチェックが出来ます。

これは、こういうコードを書いて挙動をデバッグする際にとても役立ちます。

#####さて、最後に、クロスプラットフォーム　Controlキー問題を解決します。

![](http://kenokabe.github.io/contents/entries/entry20140705/img/KeyRemap4MacBook.png)

同じタブで、`Change Command_L Key (Left Command)`
で、画面の通り、VirtualMachine、RDC、Terminalなど、UNIX世界のキーバインドで支配されるめぼしい項目にすべてチェックを入れておきます。

Seilで、旧Commandキーは、OSレベルでF18,F19にリマップ済みのはずですが、こういうバーチャルな環境ではなぜかそのままのようです。詳しい機構はよく知りませんが、いずれにせよ、これでうまくいきます。

これで、WindowsへのリモートデスクトップでもMacOS上でお馴染みのCommandキーマップでだいたいうまくいくし、MacOS上のターミナル環境下でもうまくいきます。

もちろん、Commandキーは押しやすいCapsLockの位置に変更しました。

KeyMap4Macbookについては、だいたいこんな感じですが、より詳細なウォークスルーは、
本家サイトのマニュアルにあるのでご参照下さい。
https://pqrs.org/macosx/keyremap4macbook/document.html.ja

`private.xml`の書式のドキュメンテーションは以下
https://pqrs.org/macosx/keyremap4macbook/xml.html.ja

##補足

左Control
左Option

はそのままアンタッチ。
デフォルトのまましっかり残しておくことが後々なにかと重要。

右Option
については、[TotalSpace2](http://totalspaces.binaryage.com/)でのワークスペースマネージメントのために矢印キーと同時に使用。

これで、限られたキーボード有効資源を余すことなく活用できます。


今回紹介したハックは、筆者独自の問題意識に基づき、独自に導き出した解法のひとつにすぎません。

同じ効果を実装するために他のやり方もあるでしょうし、キーバインドとは本質的に個人が使いやすいように、個人個人の趣向でカスタマイズしていくものであり、今回の設定はひとつの例示にすぎない、ということを最後に強調して申し添えておきます。

#### KenOKABE tech blog
####[←ブログコンテンツ](http://kenokabe.github.io/contents/entries/entry0/entry.html)
